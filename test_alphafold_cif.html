<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test AlphaFold CIF Files</title>
  <script src="https://unpkg.com/ngl@2.0.0-dev.37/dist/ngl.js"></script>
  <style>
    #viewport {
      width: 800px;
      height: 600px;
      border: 2px solid #333;
      margin: 20px auto;
      display: block;
    }

    .controls {
      text-align: center;
      margin: 20px;
    }

    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
    }

    .log {
      background: #f0f0f0;
      padding: 10px;
      margin: 20px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <h1>ğŸ§¬ Test AlphaFold CIF Files</h1>

  <div class="controls">
    <button onclick="testSimulatedCIF()">ğŸ§ª Test Simulated CIF</button>
    <button onclick="testRealAlphaFoldCIF()">ğŸ”¬ Test Real AlphaFold CIF</button>
    <button onclick="testServerEndpoint()">ğŸ–¥ï¸ Test Server CIF</button>
    <button onclick="testServerPDB()">ğŸ”„ Test Server PDB (Converted)</button>
    <button onclick="testDirectFile()">ğŸ“ Test Direct File</button>
    <button onclick="testAlphaFoldDirectURL()">ğŸ”— Test Direct AlphaFold URL</button>
    <button onclick="testBioStructureAPI()">ğŸŒ Test BioStructure API</button>
    <button onclick="clearViewer()">ğŸ—‘ï¸ Limpiar</button>
  </div>

  <div id="viewport"></div>

  <div class="log" id="log">
    <strong>ğŸ“‹ Log de eventos:</strong><br>
    Iniciando NGL Viewer...<br>
  </div>

  <script>
    let stage;

    function log(message) {
      const logDiv = document.getElementById('log');
      logDiv.innerHTML += new Date().toLocaleTimeString() + ": " + message + "<br>";
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    document.addEventListener('DOMContentLoaded', function () {
      try {
        // Inicializar NGL Stage
        stage = new NGL.Stage('viewport');
        log('âœ… NGL Stage inicializado correctamente');

        // Configurar el stage
        stage.setParameters({
          backgroundColor: 'white'
        });

        log('âš™ï¸ Stage configurado con fondo blanco');

      } catch (error) {
        log('âŒ Error inicializando NGL: ' + error.message);
      }
    });

    function testSimulatedCIF() {
      log('ğŸ§ª Test: Cargando CIF simulado...');

      const url = 'http://localhost:5000/test/simple.cif';
      log('ğŸ”— URL: ' + url);

      stage.removeAllComponents();

      stage.loadFile(url).then(function (component) {
        log('âœ… CIF simulado cargado exitosamente');

        component.addRepresentation('cartoon', {
          color: 'chainid'
        });

        component.autoView();
        log('ğŸ¨ RepresentaciÃ³n cartoon aÃ±adida');

      }).catch(function (error) {
        log('âŒ Error cargando CIF simulado: ' + error);
        log('ğŸ” Mensaje de error: ' + error.message);
      });
    }

    function testRealAlphaFoldCIF() {
      log('ğŸ”¬ Test: Cargando CIF real de AlphaFold...');

      const url = 'http://localhost:5000/models/alphafold/Hemoglobina Beta E6V_original_1751376457.cif';
      log('ğŸ”— URL: ' + url);

      stage.removeAllComponents();

      // First test if the file is accessible
      fetch(url)
        .then(response => {
          log('ğŸ“¡ HTTP Status: ' + response.status);
          log('ğŸ“¡ Content-Type: ' + response.headers.get('content-type'));

          if (!response.ok) {
            throw new Error('HTTP ' + response.status);
          }

          return response.text();
        })
        .then(content => {
          log('âœ… Archivo CIF obtenido, tamaÃ±o: ' + content.length + ' caracteres');
          log('ğŸ” Primeras lÃ­neas: ' + content.substring(0, 200) + '...');

          // Now try to load with NGL
          return stage.loadFile(url, {
            ext: "cif",
            firstModelOnly: true
          });
        })
        .then(function (component) {
          log('âœ… CIF real de AlphaFold cargado exitosamente en NGL');
          log('ğŸ“Š Componente info: ' + component.type);

          if (component.structure) {
            log('ğŸ“Š Ãtomos: ' + component.structure.atomCount);
            log('ğŸ“Š Residuos: ' + component.structure.residueCount);
            log('ğŸ“Š Cadenas: ' + component.structure.chainCount);
          }

          component.addRepresentation('cartoon', {
            color: 'chainid'
          });

          component.autoView();
          log('ğŸ¨ RepresentaciÃ³n cartoon aÃ±adida');

        })
        .catch(function (error) {
          log('âŒ Error cargando CIF real: ' + error);
          log('ğŸ” Mensaje de error: ' + error.message);
          log('ğŸ” Stack: ' + (error.stack || 'No stack available'));

          // Try fallback with different options
          log('ğŸ”„ Intentando con opciones alternativas...');

          stage.loadFile(url)
            .then(component => {
              log('âœ… CIF cargado con opciones por defecto');
              component.addRepresentation('cartoon', { color: 'chainid' });
              component.autoView();
            })
            .catch(fallbackError => {
              log('âŒ Fallback tambiÃ©n fallÃ³: ' + fallbackError.message);
            });
        });
    }

    function testServerEndpoint() {
      log('ğŸ–¥ï¸ Test: Probando endpoint del servidor Flask...');

      // Assuming we have comparison ID 1 or 2 in the database
      const url = 'http://localhost:5000/api/comparison/1/model/original/view.cif';
      log('ğŸ”— URL: ' + url);

      stage.removeAllComponents();

      fetch(url)
        .then(response => {
          log('ğŸ“¡ Server Response Status: ' + response.status);
          log('ğŸ“¡ Content-Type: ' + response.headers.get('content-type'));
          log('ğŸ“¡ CORS Headers: ' + response.headers.get('access-control-allow-origin'));

          if (!response.ok) {
            throw new Error('Server returned HTTP ' + response.status);
          }

          return response.text();
        })
        .then(content => {
          log('âœ… Respuesta del servidor obtenida, tamaÃ±o: ' + content.length + ' caracteres');

          // Check if it looks like a valid CIF
          if (content.includes('data_') && content.includes('_atom_site')) {
            log('âœ… El contenido parece ser un CIF vÃ¡lido');
          } else {
            log('âš ï¸ El contenido no parece ser un CIF vÃ¡lido');
          }

          // Now try to load with NGL
          return stage.loadFile(url);
        })
        .then(function (component) {
          log('âœ… CIF del servidor cargado exitosamente en NGL');

          if (component.structure) {
            log('ğŸ“Š Ãtomos: ' + component.structure.atomCount);
            log('ğŸ“Š Residuos: ' + component.structure.residueCount);
          }

          component.addRepresentation('cartoon', {
            color: 'chainid'
          });

          component.autoView();
          log('ğŸ¨ RepresentaciÃ³n cartoon aÃ±adida');

        })
        .catch(function (error) {
          log('âŒ Error con endpoint del servidor: ' + error);
          log('ğŸ” Mensaje de error: ' + error.message);
        });
    }

    function testServerPDB() {
      log('ğŸ”„ Test: Probando conversiÃ³n CIFâ†’PDB en servidor...');

      // Test the new PDB conversion endpoint
      const url = 'http://localhost:5000/api/comparison/1/model/original/view.pdb';
      log('ğŸ”— URL: ' + url);

      stage.removeAllComponents();

      fetch(url)
        .then(response => {
          log('ğŸ“¡ PDB Server Response Status: ' + response.status);
          log('ğŸ“¡ Content-Type: ' + response.headers.get('content-type'));

          if (!response.ok) {
            throw new Error('Server returned HTTP ' + response.status);
          }

          return response.text();
        })
        .then(content => {
          log('âœ… PDB convertido obtenido, tamaÃ±o: ' + content.length + ' caracteres');
          log('ğŸ” Primeras lÃ­neas: ' + content.substring(0, 200) + '...');

          // Now try to load with NGL
          return stage.loadFile(url);
        })
        .then(function (component) {
          log('âœ… PDB convertido cargado exitosamente en NGL');

          if (component.structure) {
            log('ğŸ“Š Ãtomos: ' + component.structure.atomCount);
            log('ğŸ“Š Residuos: ' + component.structure.residueCount);
          }

          component.addRepresentation('cartoon', {
            color: 'chainid'
          });

          component.autoView();
          log('ğŸ¨ RepresentaciÃ³n cartoon aÃ±adida - Â¡DeberÃ­a mostrar estructura plegada!');

        })
        .catch(function (error) {
          log('âŒ Error con PDB convertido: ' + error);
          log('ğŸ” Mensaje de error: ' + error.message);
        });
    }

    function testDirectFile() {
      log('ğŸ“ Test: Probando archivo directo via ruta estÃ¡tica...');

      const url = 'http://localhost:5000/models/alphafold/Hemoglobina%20Beta%20E6V_original_1751376457.cif';
      log('ğŸ”— URL: ' + url);

      stage.removeAllComponents();

      stage.loadFile(url)
        .then(function (component) {
          log('âœ… Archivo directo cargado exitosamente');

          if (component.structure) {
            log('ğŸ“Š Ãtomos: ' + component.structure.atomCount);
            log('ğŸ“Š Residuos: ' + component.structure.residueCount);
          }

          component.addRepresentation('cartoon', {
            color: 'chainid'
          });

          component.autoView();
          log('ğŸ¨ RepresentaciÃ³n cartoon aÃ±adida');

        })
        .catch(function (error) {
          log('âŒ Error con archivo directo: ' + error);
          log('ğŸ” Mensaje de error: ' + error.message);
        });
    }

    function testAlphaFoldDirectURL() {
      log('ğŸ”— Test: Cargando desde URL directa de AlphaFold DB...');

      // URL directa al modelo de hemoglobina de AlphaFold
      const url = 'https://alphafold.ebi.ac.uk/files/AF-P68871-F1-model_v4.cif';
      log('ğŸ”— URL: ' + url);

      stage.removeAllComponents();

      stage.loadFile(url).then(function (component) {
        log('âœ… CIF directo de AlphaFold DB cargado exitosamente');

        component.addRepresentation('cartoon', {
          color: 'chainid'
        });

        component.autoView();
        log('ğŸ¨ RepresentaciÃ³n cartoon aÃ±adida');

      }).catch(function (error) {
        log('âŒ Error cargando URL directa: ' + error);
        log('ğŸ” Mensaje de error: ' + error.message);
      });
    }

    function testBioStructureAPI() {
      log('ğŸŒ Test: Cargando mediante BioStructure API...');

      // Usar la API de estructura para hemoglobina beta
      const url = 'https://www.ebi.ac.uk/pdbe/entry-files/pdb1aby.ent';
      log('ğŸ”— URL: ' + url);

      stage.removeAllComponents();

      stage.loadFile(url).then(function (component) {
        log('âœ… Estructura desde PDB-e cargada exitosamente');

        component.addRepresentation('cartoon', {
          color: 'chainid'
        });

        component.autoView();
        log('ğŸ¨ RepresentaciÃ³n cartoon aÃ±adida');

      }).catch(function (error) {
        log('âŒ Error cargando desde PDB-e: ' + error);
        log('ğŸ” Mensaje de error: ' + error.message);
      });
    }

    function clearViewer() {
      log('ğŸ—‘ï¸ Limpiando viewer...');
      stage.removeAllComponents();
      log('âœ… Viewer limpiado');
    }
  </script>
</body>

</html>